{% extends 'base.html' %}

{% block title %}Profile - {{ user.username }}{% endblock %}

{% block content %}
<div class="flex flex-col gap-10">
    <div class="flex flex-col md:flex-row items-center gap-8 pb-10 border-b border-surface-border">
        <div class="relative group">
            <form action="{% url 'profile' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div
                    class="absolute -inset-1 bg-gradient-to-tr from-primary to-purple-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-1000">
                </div>
                <div
                    class="relative size-32 rounded-full border-4 border-background-dark overflow-hidden bg-surface-dark group hover:border-primary transition-all">
                    {% if user.profile.avatar %}
                    <img src="{{ user.profile.avatar.url }}" alt="Avatar" class="size-full object-cover">
                    {% else %}
                    <img src="https://avatar.iran.liara.run/public/{{ user.id }}" alt="Avatar"
                        class="size-full object-cover">
                    {% endif %}

                    <label for="avatar-hero-upload"
                        class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-all z-20">
                        <span class="material-symbols-outlined text-white">edit</span>
                    </label>
                    <input type="file" name="avatar" id="avatar-hero-upload" class="hidden"
                        onchange="this.form.submit()">
                </div>
            </form>
            <div
                class="absolute bottom-2 right-2 size-6 bg-emerald-500 border-4 border-background-dark rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]">
            </div>
        </div>

        <div class="flex-1 text-center md:text-left">
            <div class="flex flex-wrap items-center justify-center md:justify-start gap-3 mb-2">
                <h1 class="text-4xl font-black text-white tracking-tight uppercase">{{ user.username }}</h1>
                {% if user.is_superuser %}
                <span
                    class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded border border-primary/20 uppercase tracking-widest">Nexus
                    Admin</span>
                {% else %}
                <span
                    class="bg-primary/10 text-primary text-[10px] font-bold px-2 py-0.5 rounded border border-primary/20 uppercase tracking-widest">Authenticated
                    Unit</span>
                {% endif %}
            </div>
            <p class="text-text-muted font-mono text-sm uppercase tracking-widest">Entity_ID: {{ user.id|stringformat:"05d" }} // Registered: {{ user.date_joined|date:"M d, Y" }}</p>
        </div>

        <div class="flex gap-4">
            <a href="{% url 'password_change' %}"
                class="px-6 py-2.5 rounded-lg border border-surface-border text-white font-bold text-sm hover:border-primary transition-all flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">lock_reset</span> Reset Security
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <div class="lg:col-span-1 flex flex-col gap-6">
            <div class="bg-surface-dark border border-surface-border rounded-2xl p-6">
                <h3 class="text-lg font-black text-white mb-6 uppercase tracking-wide flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">data_usage</span> Storage Matrix
                </h3>

                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between items-baseline mb-2">
                            <span class="text-4xl font-black text-white">{{ used_mb }}</span>
                            <span class="text-text-muted font-bold text-sm">/ {{ limit }} MB</span>
                        </div>
                        <div
                            class="w-full bg-background-dark h-3 rounded-full overflow-hidden border border-surface-border">
                            <div class="bg-gradient-to-r from-primary to-purple-600 h-full shadow-[0_0_10px_rgba(244,37,140,0.5)]"
                                style="width: {{ percent }}%;"></div>
                        </div>
                        <p class="mt-2 text-right text-[10px] font-bold text-primary uppercase tracking-[0.2em]">{{ percent|floatformat:1 }}% ALLOCATED</p>
                    </div>

                    <div class="pt-6 border-t border-surface-border/50 space-y-4">
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-text-muted font-bold flex items-center gap-2">
                                <span class="size-2 rounded-full bg-primary"></span> Primary Storage
                            </span>
                            <span class="text-white font-mono font-bold">{{ used_mb }} MB</span>
                        </div>
                        <div class="flex justify-between items-center text-xs opacity-50">
                            <span class="text-text-muted font-bold flex items-center gap-2">
                                <span class="size-2 rounded-full bg-surface-border"></span> Standby Capacity
                            </span>
                            <span class="text-white font-mono font-bold">{{ remaining_mb }} MB</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h4 class="text-white font-bold uppercase text-xs mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary text-sm">upgrade</span> Expand Capacity
                    </h4>
                    <div class="space-y-3">
                        {% for plan in plans %}
                        <button onclick="startPayment('{{ plan.mb }}', '{{ plan.price }}')"
                            class="w-full p-3 bg-background-dark border border-surface-border rounded-lg hover:border-primary transition-all group relative overflow-hidden text-left">
                            <div class="relative z-10 flex justify-between items-center">
                                <div>
                                    <p class="text-white font-bold text-sm">+{{ plan.name }}</p>
                                    <p class="text-[10px] text-text-muted uppercase tracking-widest">Permanent Storage
                                    </p>
                                </div>
                                <div class="text-primary font-black text-sm">₹{{ plan.price }}</div>
                            </div>
                            <div
                                class="absolute inset-0 bg-primary/5 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300">
                            </div>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script>
            async function startPayment(mb, amount) {
                try {
                    // 1. Create Order
                    const response = await fetch("{% url 'initiate_payment' %}", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `amount=${amount}&mb=${mb}`
                    });

                    const data = await response.json();

                    if (data.error) {
                        alert("Error: " + data.error);
                        return;
                    }

                    // 2. Open Razorpay
                    var options = {
                        "key": data.key,
                        "amount": data.amount,
                        "currency": data.currency,
                        "name": "CloudShare Storage",
                        "description": "Upgrade Storage Capacity",
                        "order_id": data.order_id,
                        "handler": function (response) {
                            // 3. Verify Payment
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = "{% url 'payment_success' %}";

                            const fields = {
                                'razorpay_order_id': response.razorpay_order_id,
                                'razorpay_payment_id': response.razorpay_payment_id,
                                'razorpay_signature': response.razorpay_signature
                            };

                            for (const key in fields) {
                                const input = document.createElement('input');
                                input.type = 'hidden';
                                input.name = key;
                                input.value = fields[key];
                                form.appendChild(input);
                            }

                            document.body.appendChild(form);
                            form.submit();
                        },
                        "prefill": {
                            "name": "{{ user.username }}",
                            "email": "{{ user.email }}"
                        },
                        "theme": {
                            "color": "#F4258C"
                        }
                    };
                    var rzp1 = new Razorpay(options);
                    rzp1.open();

                } catch (error) {
                    console.error(error);
                    alert("Payment is working (coming soon in next updation)");
                }
            }
        </script>
        <div class="lg:col-span-2 bg-surface-dark border border-surface-border rounded-2xl p-8">
            <h3 class="text-xl font-black text-white mb-8 uppercase tracking-wide border-b border-surface-border pb-4">
                Nexus Parameters</h3>

            <form action="{% url 'profile' %}" method="POST" enctype="multipart/form-data"
                class="grid grid-cols-1 md:grid-cols-2 gap-8">
                {% csrf_token %}
                <input type="file" name="avatar" id="avatar-upload" class="hidden" onchange="this.form.submit()">
                <div class="space-y-2">
                    <label
                        class="text-[10px] font-bold text-text-muted uppercase tracking-[0.2em] ml-1">Username</label>
                    <div class="relative">
                        <input type="text" name="username" value="{{ user.username }}"
                            class="w-full bg-background-dark border border-surface-border text-white font-mono rounded-lg h-12 pl-12 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" />
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-primary">person</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-text-muted uppercase tracking-[0.2em] ml-1">Email
                        Protocol</label>
                    <div class="relative">
                        <input type="email" name="email" value="{{ user.email }}"
                            class="w-full bg-background-dark border border-surface-border text-white font-mono rounded-lg h-12 pl-12 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" />
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-primary">alternate_email</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-text-muted uppercase tracking-[0.2em] ml-1">Joined
                        Date</label>
                    <div class="relative">
                        <input type="text" value="{{ user.date_joined|date:'Y-m-d H:i' }}" readonly
                            class="w-full bg-background-dark border border-surface-border text-text-muted font-mono rounded-lg h-12 pl-12 focus:outline-none opacity-70" />
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-muted/50">event</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-text-muted uppercase tracking-[0.2em] ml-1">Access
                        Level</label>
                    <div class="relative">
                        <input type="text"
                            value="{% if user.is_superuser %}Level 99 (Admin){% else %}Level 1 (Standard){% endif %}"
                            readonly
                            class="w-full bg-background-dark/50 border border-surface-border text-text-muted font-mono rounded-lg h-12 pl-12 focus:outline-none cursor-not-allowed" />
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-text-muted/50">verified_user</span>
                    </div>
                </div>

                <div class="md:col-span-2 flex justify-end">
                    <button type="submit"
                        class="px-8 py-3 bg-primary hover:bg-primary-hover text-white font-black uppercase tracking-widest rounded-lg shadow-neon transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined">sync_saved_locally</span> Update Parameters
                    </button>
                </div>

                <div class="md:col-span-2 pt-6">
                    <div class="p-6 bg-red-500/5 border border-red-500/20 rounded-xl">
                        <h4 class="text-red-500 font-black uppercase text-sm mb-2">Danger Zone</h4>
                        <p class="text-text-muted text-xs mb-6">Initiating account termination will purge all uploaded
                            vectors and terminate all active links permanently.</p>
                        <button type="button"
                            class="px-6 py-2 border border-red-500/30 text-red-500 font-bold text-xs uppercase tracking-widest rounded-lg hover:bg-red-500 hover:text-white transition-all">
                            Purge Account Entity </button>
                    </div>
                </div>

                {% if is_viewing_other %}
                
                {% if transactions %}
                <div class="md:col-span-2 pt-10 mt-10 border-t border-surface-border">
                    <h3 class="text-xl font-black text-white mb-6 uppercase tracking-wide flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">receipt_long</span> Payment Interface Logs
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead>
                                <tr class="text-text-muted border-b border-surface-border">
                                    <th class="pb-3 font-bold uppercase tracking-wider">Date</th>
                                    <th class="pb-3 font-bold uppercase tracking-wider">Order ID</th>
                                    <th class="pb-3 font-bold uppercase tracking-wider">Amount</th>
                                    <th class="pb-3 font-bold uppercase tracking-wider">Storage</th>
                                    <th class="pb-3 font-bold uppercase tracking-wider text-right">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-surface-border/30">
                                {% for tx in transactions %}
                                <tr class="group hover:bg-white/5 transition-colors">
                                    <td class="py-4 font-mono text-text-muted">{{ tx.created_at|date:"Y-m-d H:i" }}</td>
                                    <td class="py-4 font-mono text-white">{{ tx.order_id }}</td>
                                    <td class="py-4 text-white font-bold">₹{{ tx.amount }}</td>
                                    <td class="py-4 text-primary font-bold">+{{ tx.storage_increase_gb }} GB</td>
                                    <td class="py-4 text-right">
                                        <span
                                            class="px-2 py-1 rounded text-[10px] font-bold uppercase 
                                                {% if tx.status == 'SUCCESS' %}bg-emerald-500/10 text-emerald-500 border border-emerald-500/20
                                                {% elif tx.status == 'FAILED' %}bg-red-500/10 text-red-500 border border-red-500/20
                                                {% else %}bg-amber-500/10 text-amber-500 border border-amber-500/20{% endif %}">
                                            {{ tx.status }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="md:col-span-2 pt-10 mt-10 border-t border-surface-border text-center py-10">
                    <p class="text-text-muted text-sm font-mono tracking-widest uppercase">No verified transaction logs
                        found for this entity.</p>
                </div>
                {% endif %}
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}